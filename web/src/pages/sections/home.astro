---
import ExamModal from '../../components/ExamModal.astro';
---
<!-- SECCIÓN 2: Aplicación Principal -->
<div id="appSection" class="h-screen relative overflow-hidden">
    <!-- Imagen de fondo para la consulta -->
    <div
        class="absolute inset-0 bg-cover bg-center bg-no-repeat"
        style="background-image: url('/images/fondo.jpg')"
    ></div>
    
    <!-- Overlay con degradado horizontal y blur -->
    <div 
        id="appOverlay" 
        class="absolute inset-0 opacity-100 transition-all duration-1000 backdrop-blur-sm"
        style="background: linear-gradient(to right, #004180cc, #c7181fcc)"
    ></div>
    
    <!-- Capa adicional para oscurecer -->
    <div 
        id="appDarkLayer"
        class="absolute inset-0 bg-black/40 opacity-100 transition-opacity duration-1000"
    ></div>

    <!-- Contenido de la aplicación -->
    <div class="relative z-10 h-full flex flex-col items-center justify-center px-6 gap-12 pb-24" id="appContent">
        
        <!-- Logo centrado -->
        <div class="animate-fade-in">
            <img
                src="/logos/ucasalx_logo.png"
                alt="UCASAL Logo"
                class="h-24 md:h-40 lg:h-48"
            />
        </div>

        <!-- Contenido centrado (título y formulario) -->
        <div class="flex flex-col items-center gap-8 animate-fade-in w-full">
            <!-- Título -->
            <h1 class="text-white text-2xl md:text-3xl lg:text-5xl font-semibold text-center animate-slide-down">
                Consulta donde rendis tu examen
            </h1>
            
            <!-- Formulario -->
            <form id="examForm" class="w-full max-w-lg animate-slide-up" onsubmit="return false;">
                <div class="flex gap-4">
                    <!-- Input DNI -->
                    <input
                        id="dniInput"
                        type="text"
                        placeholder="Ingresa tu DNI"
                        class="flex-1 px-6 py-4 text-lg rounded-lg text-white placeholder-gray-200 border-2 border-white bg-white/10 backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-white/50 focus:bg-white/20 text-center transition-all duration-300 hover:bg-white/15"
                        maxlength="8"
                        pattern="[0-9]{7,8}"
                        required
                    />
                    
                    <!-- Botón Ir -->
                    <button
                        id="searchBtn"
                        type="submit"
                        class="px-8 py-4 text-lg bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-red-500/50 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span id="searchBtnText">→</span>
                        <span id="searchBtnLoader" class="hidden">
                            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </div>
                
                <!-- Mensaje de error -->
                <div id="errorMessage" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                    <p class="text-sm">Por favor, ingresa un DNI válido (7-8 dígitos).</p>
                </div>
                
                <!-- Mensaje de "no encontrado" -->
                <div id="notFoundMessage" class="hidden mt-4 p-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-lg">
                    <p class="text-sm">No se encontraron exámenes para el DNI ingresado. Verifica que el número sea correcto.</p>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Incluir el componente del modal -->
<ExamModal />

<style>
  /* Animaciones */
  @keyframes fade-in {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .animate-fade-in {
    animation: fade-in 1s ease-out;
  }
  
  @keyframes slide-down {
    from { opacity: 0; transform: translateY(-30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .animate-slide-down {
    animation: slide-down 1s ease-out 0.5s both;
  }
  
  @keyframes slide-up {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .animate-slide-up {
    animation: slide-up 1s ease-out 1s both;
  }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('examForm') as HTMLFormElement;
        const dniInput = document.getElementById('dniInput') as HTMLInputElement;
        const searchBtn = document.getElementById('searchBtn') as HTMLButtonElement;
        const searchBtnText = document.getElementById('searchBtnText');
        const searchBtnLoader = document.getElementById('searchBtnLoader');
        const errorMessage = document.getElementById('errorMessage');
        const notFoundMessage = document.getElementById('notFoundMessage');
        
        // Función para mostrar el estado de carga
        function showLoading() {
            if (searchBtn) searchBtn.disabled = true;
            searchBtnText?.classList.add('hidden');
            searchBtnLoader?.classList.remove('hidden');
        }
        
        // Función para ocultar el estado de carga
        function hideLoading() {
            if (searchBtn) searchBtn.disabled = false;
            searchBtnText?.classList.remove('hidden');
            searchBtnLoader?.classList.add('hidden');
        }
        
        // Función para mostrar mensaje de error
        function showError() {
            errorMessage?.classList.remove('hidden');
            notFoundMessage?.classList.add('hidden');
        }
        
        // Función para mostrar mensaje de "no encontrado"
        function showNotFound() {
            notFoundMessage?.classList.remove('hidden');
            errorMessage?.classList.add('hidden');
        }
        
        // Función para ocultar mensajes
        function hideMessages() {
            errorMessage?.classList.add('hidden');
            notFoundMessage?.classList.add('hidden');
        }
        
        // Validación del DNI
        function validateDNI(dni: string): boolean {
            const dniRegex = /^[0-9]{7,8}$/;
            const isValid = dniRegex.test(dni) && dni.length >= 7 && dni.length <= 8;
            console.log(`Validando DNI: "${dni}" - Válido: ${isValid}`);
            return isValid;
        }
        
        // Búsqueda real de exámenes usando la API
        async function searchExam(dni: string): Promise<{found: boolean; examData?: any}> {
            try {
                console.log('Consultando exámenes para DNI:', dni);
                
                // Llamar a nuestro endpoint
                const response = await fetch(`http://localhost:3000/api/v1/estudiantes/examenes/${dni}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        return { found: false };
                    }
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const apiResult = await response.json();
                
                if (!apiResult.success || !apiResult.data.examenes || apiResult.data.examenes.length === 0) {
                    return { found: false };
                }
                
                // Transformar datos de la API al formato esperado por el modal
                const examData = {
                    dni: apiResult.data.estudiante.dni,
                    estudiante: {
                        nombre: apiResult.data.estudiante.nombre,
                        carrera: apiResult.data.examenes[0]?.carrera?.nombre || 'No especificada',
                        lugar: apiResult.data.estudiante.lugar,
                        sector: apiResult.data.estudiante.sector
                    },
                    examenes: apiResult.data.examenes.map((examen: any) => ({
                        materia: examen.materia?.nombre || examen.materia?.nombreCorto || 'Materia no especificada',
                        fecha: formatearFecha(examen.fecha || examen.fechaExterna),
                        hora: examen.hora || 'Hora no especificada',
                        aula: examen.aula?.nombre || 'Sin asignar',
                        ubicacion: examen.aula?.ubicacion || '',
                        tipo: examen.tipoExamen || 'No especificado',
                        modalidad: examen.modalidad || 'presencial',
                        profesor: examen.docente || 'No especificado',
                        observaciones: examen.observaciones || '',
                        materialPermitido: examen.materialPermitido || '',
                        requierePc: examen.requierePc || false,
                        carrera: examen.carrera?.nombre || 'No especificada',
                        facultad: examen.carrera?.facultad || 'No especificada'
                    }))
                };
                
                console.log('Exámenes procesados:', examData);
                
                return {
                    found: true,
                    examData: examData
                };
                
            } catch (error) {
                console.error('Error al consultar API:', error);
                throw error;
            }
        }
        
        // Función auxiliar para formatear fechas (CORREGIDO: usar UTC para evitar problemas de zona horaria)
        function formatearFecha(fecha: string | null): string {
            if (!fecha) return 'Fecha no especificada';
            
            try {
                // Usar UTC para evitar problemas de zona horaria
                const fechaObj = new Date(fecha + 'T00:00:00.000Z');
                const hoy = new Date();
                const hoyUTC = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
                const manana = new Date(hoyUTC);
                manana.setDate(hoyUTC.getDate() + 1);
                
                const fechaStr = fechaObj.toISOString().split('T')[0];
                const hoyStr = hoyUTC.toISOString().split('T')[0];
                const mananaStr = manana.toISOString().split('T')[0];
                
                if (fechaStr === hoyStr) {
                    return `Hoy - ${fechaObj.getUTCDate()} ${obtenerNombreMes(fechaObj.getUTCMonth())}`;
                } else if (fechaStr === mananaStr) {
                    return `Mañana - ${fechaObj.getUTCDate()} ${obtenerNombreMes(fechaObj.getUTCMonth())}`;
                } else {
                    return `${fechaObj.getUTCDate()} ${obtenerNombreMes(fechaObj.getUTCMonth())} ${fechaObj.getUTCFullYear()}`;
                }
            } catch (error) {
                return fecha;
            }
        }
        
        // Función auxiliar para obtener nombre del mes
        function obtenerNombreMes(mes: number): string {
            const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                          'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return meses[mes] || '';
        }
        
        // Event listener para el input DNI (solo números)
        dniInput?.addEventListener('input', function(e) {
            // Permitir solo números
            const target = e.target as HTMLInputElement;
            if (target) {
                target.value = target.value.replace(/[^0-9]/g, '');
            }
            hideMessages();
        });
        
        // Event listener para el formulario
        form?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const dni = dniInput?.value.trim() || '';
            console.log('DNI ingresado:', dni, 'Longitud:', dni.length);
            
            if (!dni) {
                console.log('DNI vacío');
                showError();
                return;
            }
            
            if (!validateDNI(dni)) {
                console.log('DNI no válido según regex:', dni);
                showError();
                return;
            }
            
            console.log('DNI válido, iniciando búsqueda...');
            hideMessages();
            showLoading();
            
            try {
                const result = await searchExam(dni);
                
                if (result.found) {
                    console.log('Examen encontrado! Abriendo modal...');
                    
                    // Usar el componente ExamModal
                    const ExamModal = (window as any).ExamModal;
                    if (ExamModal) {
                        ExamModal.setCurrentExamData(result.examData);
                        ExamModal.openExamModal();
                    }
                } else {
                    showNotFound();
                }
            } catch (error) {
                console.error('Error al buscar examen:', error);
                showError();
            } finally {
                hideLoading();
            }
        });
        
        // Event listener para el botón (alternativo)
        searchBtn?.addEventListener('click', function(e) {
            const target = e.target as HTMLButtonElement;
            if (target?.type === 'submit') return; // Ya lo maneja el form
            form?.dispatchEvent(new Event('submit'));
        });
    });
</script>
