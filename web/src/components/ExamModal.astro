---
// Propiedades simuladas del examen para mostrar datos ilustrativos
const examData = {
  estudiante: {
    dni: "12345678",
    nombre: "Mar√≠a Gonz√°lez",
    carrera: "Licenciatura en Administraci√≥n"
  },
  examen: {
    materia: "SISTEMAS ADMINISTRATIVOS CONTABLES",
    codigo: "2120",
    fecha: "5 de Junio, 2025",
    hora: "14:00",
    tipo: "Escrito en sede",
    turno: "1¬∞ Turno Ordinario"
  },
  ubicacion: {
    sector: "Econom√≠a y Administraci√≥n",
    aula: "Aula 203 - Edificio Principal",
    direccion: "Campus UCASAL - Casta√±ares 751"
  },
  profesor: {
    nombre: "JOSE ALEJANDRO LAMAS",
    catedra: "A",
    email: "j.lamas@ucasal.edu.ar"
  },
  instrucciones: {
    materialPermitido: "Calculadora, hojas en blanco proporcionadas por la universidad",
    observaciones: "Presentarse 15 minutos antes del horario del examen. Traer documento de identidad.",
    monitoreo: "PROCTORING",
    responsable: "ANDREA TEJERINA"
  }
}
---

<!-- Modal de ex√°menes mejorado -->
<div id="examModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 pointer-events-none transition-all duration-300" style="z-index: 9999;">
  <div class="bg-white rounded-3xl max-w-3xl w-full shadow-2xl transform scale-95 transition-all duration-300 max-h-[90vh] overflow-y-auto">
    
    <!-- Header con informaci√≥n del estudiante -->
    <div class="bg-gradient-to-r from-blue-900 to-red-600 text-white p-6 rounded-t-3xl">
      <div class="flex items-center justify-between">
        <div class="flex-1">
          <div class="mb-3">
            <h2 id="studentName" class="text-2xl font-bold">-</h2>
            <p id="studentDni" class="text-blue-100 text-lg">DNI: -</p>
          </div>
          <div class="bg-white/10 rounded-lg px-3 py-2 inline-block">
            <p id="studentCareer" class="text-sm font-medium">-</p>
          </div>
        </div>
        <button id="closeModal" class="text-white/80 hover:text-white transition-colors p-3 hover:bg-white/10 rounded-xl ml-4">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Lista de ex√°menes optimizada para escaneo r√°pido -->
    <div class="p-6" id="examsList">
      <!-- Los ex√°menes se insertan din√°micamente aqu√≠ -->
    </div>

    <!-- Footer con bot√≥n de cerrar -->
    <div class="p-6 border-t border-gray-100 bg-gray-50 rounded-b-3xl">
      <!-- Indicador de auto-close -->
      <div id="autoCloseIndicator" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
        <div class="flex items-center justify-center space-x-2 text-blue-700">
          <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span class="text-sm font-medium">Este modal se cerrar√° autom√°ticamente en <span id="countdown">15</span> segundos</span>
        </div>
      </div>
      
      <button id="closeModalBtn" class="w-full py-4 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white rounded-xl font-semibold transition-all duration-200 text-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02]">
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- Modal de Mapa -->
<div id="mapModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 pointer-events-none transition-all duration-300" style="z-index: 10000;">
  <div class="bg-white rounded-3xl max-w-4xl w-full shadow-2xl transform scale-95 transition-all duration-300 max-h-[90vh] overflow-y-auto">
    
    <!-- Header del mapa -->
    <div class="bg-gradient-to-r from-purple-600 to-purple-800 text-white p-6 rounded-t-3xl">
      <div class="flex items-center justify-between">
        <div class="flex-1">
          <h2 id="mapTitle" class="text-2xl font-bold">Mapa del Campus</h2>
          <p id="mapSubtitle" class="text-purple-100 text-lg">Ubicaci√≥n del aula</p>
        </div>
        <button id="closeMapModal" class="text-white/80 hover:text-white transition-colors p-3 hover:bg-white/10 rounded-xl ml-4">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Contenido del mapa -->
    <div class="p-6">
      <div id="mapContent" class="text-center">
        <!-- El mapa se carga aqu√≠ din√°micamente -->
      </div>
    </div>

    <!-- Footer -->
    <div class="p-6 border-t border-gray-100 bg-gray-50 rounded-b-3xl">
      <button id="closeMapModalBtn" class="w-full py-4 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white rounded-xl font-semibold transition-all duration-200 text-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02]">
        Cerrar Mapa
      </button>
    </div>
  </div>
</div>

<style>
  #examModal {
    z-index: 9999 !important;
  }
  
  .modal-open {
    opacity: 1 !important;
    pointer-events: auto !important;
    display: flex !important;
  }
  
  .modal-open > div {
    transform: scale(1) !important;
  }
  
  /* Animaciones suaves */
  .exam-card {
    transition: all 0.2s ease;
  }
  
  .exam-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }
  
  /* Gradientes personalizados - SIN SOMBRA */
  .subject-badge {
    background: linear-gradient(135deg, #1e40af, #3b82f6);
  }
  
  /* Responsive */
  @media (max-width: 640px) {
    .grid-cols-2 {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
    // Variables globales para los modales
    let currentExamData: any = null;
    let modalAutoCloseTimer: number | null = null;
    let countdownTimer: number | null = null;
    let countdownSeconds = 15;

    // Funciones del modal
    function openExamModal() {
        console.log('Abriendo modal con datos:', currentExamData);
        const modal = document.getElementById('examModal');
        if (modal && currentExamData) {
            populateModal(currentExamData);
            modal.classList.add('modal-open');
            
            // Bloquear scroll cuando el modal est√© abierto
            document.body.style.overflow = 'hidden';
            
            // üïê Configurar auto-close despu√©s de 15 segundos
            modalAutoCloseTimer = window.setTimeout(() => {
                console.log('‚è∞ Auto-cerrando modal despu√©s de 15 segundos');
                closeModal();
            }, 15000);
            
            // üìä Mostrar indicador de countdown
            iniciarCountdown();
            
            console.log('‚è∞ Modal se cerrar√° autom√°ticamente en 15 segundos');
        } else {
            console.error('Modal element o datos no encontrados!');
        }
    }
    
    function closeModal() {
        const modal = document.getElementById('examModal');
        modal?.classList.remove('modal-open');
        
        // üïê Limpiar timer de auto-close si existe
        if (modalAutoCloseTimer) {
            clearTimeout(modalAutoCloseTimer);
            modalAutoCloseTimer = null;
            console.log('‚è∞ Timer de auto-close cancelado');
        }
        
        // üìä Limpiar countdown timer si existe
        if (countdownTimer) {
            clearInterval(countdownTimer);
            countdownTimer = null;
        }
        
        // Ocultar indicador de countdown
        const autoCloseIndicator = document.getElementById('autoCloseIndicator');
        autoCloseIndicator?.classList.add('hidden');
        
        // Desbloquear scroll
        document.body.style.overflow = 'auto';
        
        // üßπ Resetear formulario completo
        resetearFormulario();
        
        // Resetear: volver a la primera secci√≥n (video)
        setTimeout(() => {
            const videoSection = document.getElementById('videoSection');
            if (videoSection) {
                videoSection.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        }, 300);
    }
    
    // üßπ Funci√≥n para resetear el formulario completamente
    function resetearFormulario() {
        // Limpiar input DNI
        const dniInput = document.getElementById('dniInput') as HTMLInputElement;
        if (dniInput) {
            dniInput.value = '';
        }
        
        // Ocultar mensajes de error y "no encontrado"
        const errorMessage = document.getElementById('errorMessage');
        const notFoundMessage = document.getElementById('notFoundMessage');
        errorMessage?.classList.add('hidden');
        notFoundMessage?.classList.add('hidden');
        
        // Resetear bot√≥n de b√∫squeda
        const searchBtn = document.getElementById('searchBtn') as HTMLButtonElement;
        const searchBtnText = document.getElementById('searchBtnText');
        const searchBtnLoader = document.getElementById('searchBtnLoader');
        
        if (searchBtn) searchBtn.disabled = false;
        searchBtnText?.classList.remove('hidden');
        searchBtnLoader?.classList.add('hidden');
        
        // üó∫Ô∏è Cerrar modal de mapa si est√° abierto
        const mapModal = document.getElementById('mapModal');
        if (mapModal?.classList.contains('modal-open')) {
            closeMapModal();
        }
        
        // Limpiar datos actuales
        currentExamData = null;
        
        console.log('üßπ Formulario reseteado completamente');
    }
    
    // üìä Funci√≥n para iniciar el countdown visual
    function iniciarCountdown() {
        countdownSeconds = 15;
        const autoCloseIndicator = document.getElementById('autoCloseIndicator');
        const countdownElement = document.getElementById('countdown');
        
        // Mostrar el indicador
        autoCloseIndicator?.classList.remove('hidden');
        
        // Actualizar countdown cada segundo
        countdownTimer = window.setInterval(() => {
            countdownSeconds--;
            
            if (countdownElement) {
                countdownElement.textContent = countdownSeconds.toString();
            }
            
            // Si llega a 0, parar el timer (el modal ya se habr√° cerrado)
            if (countdownSeconds <= 0) {
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                }
            }
        }, 1000);
    }
    
    // Funci√≥n para formatear hora sin segundos
    function formatearHora(hora: string): string {
        if (!hora) return 'Hora no especificada';
        
        // Si viene en formato HH:MM:SS, extraer solo HH:MM
        if (hora.includes(':')) {
            const partes = hora.split(':');
            if (partes.length >= 2) {
                return `${partes[0]}:${partes[1]}`;
            }
        }
        
        return hora;
    }
    
    // Funci√≥n para formatear carrera y facultad
    function formatearCarreraFacultad(carrera: string, facultad: string): string {
        if (!facultad && !carrera) return 'Carrera no especificada';
        if (!facultad) return carrera;
        if (!carrera) return facultad;
        
        // Formato: "Facultad de X - Carrera"
        let facultadFormateada = facultad;
        if (!facultad.toLowerCase().includes('facultad')) {
            facultadFormateada = `Facultad de ${facultad}`;
        }
        
        return `${facultadFormateada} - ${carrera}`;
    }
    
    // Poblar el modal con datos optimizado para UX
    function populateModal(data: any) {
        console.log('Poblando modal con:', data);
        
        // Actualizar informaci√≥n del estudiante en el header
        const studentName = document.getElementById('studentName');
        const studentDni = document.getElementById('studentDni');
        const studentCareer = document.getElementById('studentCareer');
        
        if (studentName) studentName.textContent = data.estudiante?.nombre || 'Nombre no disponible';
        if (studentDni) studentDni.textContent = `DNI: ${data.dni || 'No disponible'}`;
        
        // Formatear carrera con facultad
        if (studentCareer) {
            const carreraFormateada = formatearCarreraFacultad(
                data.estudiante?.carrera || '',
                data.examenes?.[0]?.facultad || ''
            );
            studentCareer.textContent = carreraFormateada;
        }
        
        // Generar lista de ex√°menes con dise√±o optimizado
        const examsList = document.getElementById('examsList');
        
        if (examsList && data.examenes) {
            examsList.innerHTML = data.examenes.map((exam: any, index: number) => `
                <div class="exam-card bg-white border-2 border-gray-100 rounded-2xl p-6 mb-6 shadow-lg ${index > 0 ? 'mt-6' : ''}">
                    
                    <!-- 1. MATERIA - Elemento m√°s prominente (SIN SOMBRA) -->
                    <div class="text-center mb-6">
                        <div class="subject-badge inline-block px-6 py-3 rounded-xl">
                            <h3 class="text-2xl font-bold leading-tight">${exam.materia || 'Materia no especificada'}</h3>
                        </div>
                    </div>
                    
                    <!-- 2. AULA Y HORA - Segunda prioridad en grid -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <!-- AULA -->
                        <div class="bg-green-50 border border-green-200 p-4 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                            <p class="text-xl font-bold text-gray-800">${exam.aula ? `${exam.aula}` : 'Aula sin asignar'}</p>
                        </div>
                        
                        <!-- HORA -->
                        <div class="bg-red-50 border border-red-200 p-4 rounded-xl text-center">
                            <div class="flex items-center justify-center mb-2">
                                <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="text-sm font-semibold text-red-700 uppercase tracking-wide">HORA</span>
                            </div>
                            <p class="text-xl font-bold text-gray-800">${formatearHora(exam.hora)}</p>
                        </div>
                    </div>
                    
                    <!-- 3. INFORMACI√ìN SECUNDARIA en grid de 2 columnas -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <!-- FECHA -->
                        <div class="bg-blue-50 border border-blue-200 p-4 rounded-xl text-center">
                            <div class="flex items-center justify-center mb-2">
                                <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <span class="text-sm font-semibold text-blue-700 uppercase tracking-wide">FECHA</span>
                            </div>
                            <p class="text-lg font-bold text-gray-800">${exam.fecha || 'Fecha no especificada'}</p>
                        </div>
                        
                        <!-- MAPA -->
                        <div class="bg-purple-50 border border-purple-200 p-4 rounded-xl text-center cursor-pointer hover:bg-purple-100 transition-colors" onclick="mostrarMapa('${exam.aula || null}')">
                            <div class="flex items-center justify-center mb-2">
                                <svg class="w-5 h-5 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <span class="text-sm font-semibold text-purple-700 uppercase tracking-wide">MAPA</span>
                            </div>
                            <p class="text-lg font-bold text-gray-800">${exam.aula ? 'Ver ubicaci√≥n' : 'Aula sin asignar'}</p>
                        </div>
                    </div>
                    
                    <!-- 4. TIPO DE EXAMEN - Informaci√≥n adicional -->
                    <div class="text-center">
                        <div class="bg-orange-50 border border-orange-200 p-4 rounded-xl inline-block">
                            <div class="flex items-center justify-center mb-2">
                                <svg class="w-5 h-5 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span class="text-sm font-semibold text-orange-700 uppercase tracking-wide">TIPO DE EXAMEN</span>
                            </div>
                            <p class="text-lg font-bold text-gray-800">${exam.tipo || 'No especificado'}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    // Funci√≥n para mostrar mapa seg√∫n el aula
    function mostrarMapa(aula: string | null) {
        if (!aula || aula === 'null' || aula === 'Sin asignar' || aula === 'Aula sin asignar') {
            alert('No hay aula asignada para mostrar en el mapa');
            return;
        }
        
        const mapModal = document.getElementById('mapModal');
        const mapTitle = document.getElementById('mapTitle');
        const mapSubtitle = document.getElementById('mapSubtitle');
        const mapContent = document.getElementById('mapContent');
        
        if (!mapModal || !mapTitle || !mapSubtitle || !mapContent) {
            console.error('Elementos del modal de mapa no encontrados');
            return;
        }
        
        // Determinar qu√© mapa mostrar seg√∫n el aula
        let imagenMapa = '';
        let tituloMapa = '';
        let ubicacionMapa = '';
        
        // MAPEO CORRECTO: Primer Piso vs Planta Baja
        const aulaStr = aula.toString().toUpperCase();
        const esPrimerPiso = aulaStr.includes('4') || 
                           aulaStr.includes('8') || 
                           aulaStr.includes('LAB') || 
                           aulaStr.includes('LABORATORIO');
        
        if (esPrimerPiso) {
            // Aulas del primer piso: 4, 8, Laboratorio
            imagenMapa = './images/primerPiso.jpg';
            tituloMapa = 'Mapa del Campus - Primer Piso';
            ubicacionMapa = 'Primer Piso';
        } else {
            // Aulas de planta baja: 12
            imagenMapa = './images/plantaBaja.jpg';
            tituloMapa = 'Mapa del Campus - Planta Baja';
            ubicacionMapa = 'Planta Baja';
        }
        
        // Actualizar contenido del modal
        mapTitle.textContent = tituloMapa;
        mapSubtitle.textContent = `Aula ${aula} - ${ubicacionMapa}`;
        
        mapContent.innerHTML = `
            <div class="bg-gray-50 p-4 rounded-xl mb-4">
                <p class="text-lg font-semibold text-gray-800 mb-2">üìç Ubicaci√≥n: Aula ${aula}</p>
                <p class="text-gray-600">${ubicacionMapa}</p>
            </div>
            
            <div class="border-2 border-gray-200 rounded-xl overflow-hidden shadow-lg">
                <img 
                    src="${imagenMapa}" 
                    alt="Mapa de ${tituloMapa}" 
                    class="w-full h-auto max-h-96 object-cover bg-white"
                    onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDQwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRjNGNEY2Ii8+Cjx0ZXh0IHg9IjIwMCIgeT0iMTUwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNkI3MjgwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiPk1hcGEgbm8gZGlzcG9uaWJsZTwvdGV4dD4KPHRleHQgeD0iMjAwIiB5PSIxODAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM2QjcyODAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCI+U3ViZSBsYSBpbWFnZW4gYSAvd2ViL3B1YmxpYy9pbWFnZXMvPC90ZXh0Pgo8L3N2Zz4K'; this.onerror=null;"
                />
            </div>
            
            <div class="mt-4 text-sm text-gray-600">
                <p><strong>üí° Instrucciones:</strong></p>
                <p>‚Ä¢ Busca la zona marcada con "Aula ${aula}" en el mapa</p>
                <p>‚Ä¢ Pregunta al personal si necesitas orientaci√≥n adicional</p>
            </div>
        `;
        
        // Mostrar modal
        mapModal.classList.add('modal-open');
        document.body.style.overflow = 'hidden';
    }
    
    // Funci√≥n para cerrar modal de mapa
    function closeMapModal() {
        const mapModal = document.getElementById('mapModal');
        mapModal?.classList.remove('modal-open');
        document.body.style.overflow = 'auto';
    }

    // Event listeners cuando el DOM est√© listo (UNIFICADO)
    document.addEventListener('DOMContentLoaded', function() {
        const closeModalBtn = document.getElementById('closeModal');
        const closeModalFooter = document.getElementById('closeModalBtn');
        const modal = document.getElementById('examModal');
        
        // Modal de mapa
        const closeMapModalBtn = document.getElementById('closeMapModal');
        const closeMapModalFooter = document.getElementById('closeMapModalBtn');
        const mapModal = document.getElementById('mapModal');

        // Event listeners para el modal principal
        closeModalBtn?.addEventListener('click', closeModal);
        closeModalFooter?.addEventListener('click', closeModal);
        
        // Event listeners para el modal de mapa
        closeMapModalBtn?.addEventListener('click', closeMapModal);
        closeMapModalFooter?.addEventListener('click', closeMapModal);
        
        // Cerrar modal al hacer click en el fondo
        modal?.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
        
        mapModal?.addEventListener('click', function(e) {
            if (e.target === mapModal) {
                closeMapModal();
            }
        });
        
        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const mapModalOpen = mapModal?.classList.contains('modal-open');
                const examModalOpen = modal?.classList.contains('modal-open');
                
                if (mapModalOpen) {
                    closeMapModal();
                } else if (examModalOpen) {
                    closeModal();
                }
            }
        });
    });

    // Hacer funci√≥n mostrarMapa global
    (window as any).mostrarMapa = mostrarMapa;

    // Exportar funciones para que puedan ser usadas desde otras secciones
    (window as any).ExamModal = {
        openExamModal,
        closeModal,
        setCurrentExamData: (data: any) => { currentExamData = data; },
        mostrarMapa
    };
</script> 